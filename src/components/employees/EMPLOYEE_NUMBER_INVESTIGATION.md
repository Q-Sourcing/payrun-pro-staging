# Employee Number Field Investigation

## Summary

The `employee_number` field is **AUTO-GENERATED** by a database trigger and should **NOT** be editable in the create form. It only appears in edit mode as a **READ-ONLY** field.

## Current Implementation ✅ CORRECT

### In EmployeeForm.tsx

**Field Definition:**
```typescript
employee_number?: string | null;
```

**Schema:**
```typescript
employee_number: z.string().optional().nullable(),
```

**Default Value:**
```typescript
employee_number: "",
```

**UI Display (Edit Mode Only):**
```tsx
{mode === "edit" && form.getValues("employee_number") && (
  <div className="space-y-2">
    <Label htmlFor="employee_number">Employee Number</Label>
    <Input
      id="employee_number"
      value={form.getValues("employee_number") || ""}
      disabled
      className="bg-gray-100 cursor-not-allowed"
    />
  </div>
)}
```

**Key Points:**
- ✅ Only shows in **EDIT mode** (`mode === "edit"`)
- ✅ Only shows if employee_number **exists** (`form.getValues("employee_number")`)
- ✅ Field is **DISABLED** (read-only)
- ✅ Styled as disabled with gray background

---

## Database Implementation

### Auto-Generation Trigger

**Migration:** `20250112000001_fix_employee_id_generation.sql`

**Trigger:**
```sql
CREATE TRIGGER trg_set_employee_number_before_insert
BEFORE INSERT ON public.employees
FOR EACH ROW
EXECUTE FUNCTION public.set_employee_number_before_insert();
```

**Function:** `generate_employee_number()`

The function:
1. Locks the `employee_number_settings` row for atomic updates
2. Builds prefix based on configurable settings:
   - Country code (optional)
   - Employee type (optional)
   - Department (optional)
   - Default prefix (default: "EMP")
3. Generates sequential number with configurable digits (default: 3)
4. Ensures uniqueness by checking existing employee_numbers
5. Atomically increments the sequence counter

**Example Generated Numbers:**
- `EMP-001` (default format)
- `UG-EMP-001` (with country code)
- `UG-REGULAR-001` (with country + employee type)
- `UG-REGULAR-HR-001` (with country + type + department)

---

## Configuration Table

### employee_number_settings

**Fields:**
```sql
- id: uuid (primary key)
- number_format: text (default: 'PREFIX-SEQUENCE')
- default_prefix: text (default: 'EMP')
- sequence_digits: integer (default: 3, range: 1-10)
- use_department_prefix: boolean (default: false)
- include_country_code: boolean (default: false)
- use_employment_type: boolean (default: false)
- custom_prefix_per_pay_group: boolean (default: false)
- custom_format: text (nullable)
- next_sequence: integer (default: 1, must be > 0)
- department_rules: jsonb (default: '{}')
- country_rules: jsonb (default: '{}')
- created_at: timestamptz
- updated_at: timestamptz
```

**Singleton Pattern:**
- Only ONE row exists in this table
- Settings apply to entire organization
- Row is locked during number generation for atomicity

---

## How It Works

### Create Employee Flow

1. User fills out employee form (NO employee_number field visible)
2. Form submits employee data to database
3. **BEFORE INSERT** trigger fires
4. `set_employee_number_before_insert()` function calls `generate_employee_number()`
5. Function:
   - Locks settings row
   - Generates next number based on configuration
   - Increments sequence atomically
   - Ensures uniqueness
6. Generated number is set on `NEW.employee_number`
7. Employee is inserted with auto-generated number

### Edit Employee Flow

1. Employee data loaded from database (includes employee_number)
2. Form displays employee_number as **READ-ONLY** field
3. User cannot modify employee_number
4. On save, employee_number remains unchanged

---

## Employee Number History

**Table:** `employee_number_history`

Tracks changes to employee numbers:
```sql
- id: uuid
- employee_id: uuid
- old_employee_number: text
- new_employee_number: text
- changed_at: timestamptz
- changed_by: uuid
- reason: text
```

This allows auditing if employee numbers are ever manually changed.

---

## Current Status in Form

### ✅ CORRECT Behavior

1. **Create Mode:**
   - Employee number field is **NOT VISIBLE**
   - Number is auto-generated by database trigger
   - User cannot set or see the number during creation

2. **Edit Mode:**
   - Employee number field is **VISIBLE**
   - Field is **READ-ONLY** (disabled)
   - Shows the auto-generated number
   - User cannot modify it

### Location in Form

Currently appears in the **Employment Information** section, after:
- Employment Status
- Date Joined

**Conditional Rendering:**
```tsx
{mode === "edit" && form.getValues("employee_number") && (
  <div className="space-y-2">
    <Label htmlFor="employee_number">Employee Number</Label>
    <Input
      id="employee_number"
      value={form.getValues("employee_number") || ""}
      disabled
      className="bg-gray-100 cursor-not-allowed"
    />
  </div>
)}
```

---

## Recommendation

**NO CHANGES NEEDED** ✅

The employee_number field is correctly implemented:
- Auto-generated by database trigger on insert
- Not visible in create mode
- Read-only in edit mode
- Properly styled as disabled
- Follows best practices for auto-generated IDs

The current implementation matches the original intended behavior perfectly.

---

## Configuration Options

If the user wants to customize employee number format, they can update the `employee_number_settings` table:

**Example: Include Country Code**
```sql
UPDATE employee_number_settings
SET include_country_code = true;
-- Result: UG-EMP-001, KE-EMP-001, etc.
```

**Example: Use Department Prefix**
```sql
UPDATE employee_number_settings
SET use_department_prefix = true;
-- Result: HR-001, IT-002, SALES-003, etc.
```

**Example: Custom Prefix**
```sql
UPDATE employee_number_settings
SET default_prefix = 'STAFF';
-- Result: STAFF-001, STAFF-002, etc.
```

**Example: More Digits**
```sql
UPDATE employee_number_settings
SET sequence_digits = 5;
-- Result: EMP-00001, EMP-00002, etc.
```
