Initialising login role...
Connecting to remote database...
Do you want to push these migrations to the remote database?
 • 20260104000000_rename_departments_to_sub_departments.sql
 • 20260104203000_create_notification_templates.sql
 • 20260105000000_enhance_rbac_grants.sql

 [Y/n] Applying migration 20260104000000_rename_departments_to_sub_departments.sql...
NOTICE (00000): policy "Enable read access for authenticated users" for relation "public.head_office_pay_group_members" does not exist, skipping
NOTICE (00000): policy "Enable read access for authenticated users" for relation "public.head_office_pay_groups_regular" does not exist, skipping
NOTICE (00000): policy "Enable read access for authenticated users" for relation "public.head_office_pay_groups_interns" does not exist, skipping
NOTICE (00000): policy "Enable read access for authenticated users" for relation "public.head_office_pay_groups_expatriates" does not exist, skipping
NOTICE (00000): policy "Enable read access for authenticated users" for relation "public.sub_departments" does not exist, skipping
NOTICE (00000): policy "Enable insert access for authenticated users" for relation "public.head_office_pay_group_members" does not exist, skipping
NOTICE (00000): policy "Enable insert access for authenticated users" for relation "public.head_office_pay_groups_regular" does not exist, skipping
NOTICE (00000): policy "Enable insert access for authenticated users" for relation "public.head_office_pay_groups_interns" does not exist, skipping
NOTICE (00000): policy "Enable insert access for authenticated users" for relation "public.head_office_pay_groups_expatriates" does not exist, skipping
NOTICE (00000): policy "Enable insert access for authenticated users" for relation "public.sub_departments" does not exist, skipping
NOTICE (00000): policy "Enable update access for authenticated users" for relation "public.head_office_pay_group_members" does not exist, skipping
NOTICE (00000): policy "Enable update access for authenticated users" for relation "public.head_office_pay_groups_regular" does not exist, skipping
NOTICE (00000): policy "Enable update access for authenticated users" for relation "public.head_office_pay_groups_interns" does not exist, skipping
NOTICE (00000): policy "Enable update access for authenticated users" for relation "public.head_office_pay_groups_expatriates" does not exist, skipping
NOTICE (00000): policy "Enable update access for authenticated users" for relation "public.sub_departments" does not exist, skipping
NOTICE (00000): policy "Enable delete access for authenticated users" for relation "public.head_office_pay_group_members" does not exist, skipping
NOTICE (00000): policy "Enable delete access for authenticated users" for relation "public.head_office_pay_groups_regular" does not exist, skipping
NOTICE (00000): policy "Enable delete access for authenticated users" for relation "public.head_office_pay_groups_interns" does not exist, skipping
NOTICE (00000): policy "Enable delete access for authenticated users" for relation "public.head_office_pay_groups_expatriates" does not exist, skipping
NOTICE (00000): policy "Enable delete access for authenticated users" for relation "public.sub_departments" does not exist, skipping
NOTICE (00000): policy "Sub-Department managers can view sub-department users" for relation "public.users" does not exist, skipping
ERROR: cannot change name of input parameter "in_department" (SQLSTATE 42P13)                                                 
At statement: 42                                                                                                              
-- Update generate_employee_number                                                                                            
CREATE OR REPLACE FUNCTION public.generate_employee_number(                                                                   
  in_sub_department text,                                                                                                     
  in_country text,                                                                                                            
  in_employee_type text,                                                                                                      
  in_pay_group_id uuid,                                                                                                       
  in_prefix_override text DEFAULT NULL                                                                                        
) RETURNS text                                                                                                                
LANGUAGE plpgsql                                                                                                              
AS $$                                                                                                                         
DECLARE                                                                                                                       
  s record;                                                                                                                   
  prefix_parts text[] := ARRAY[]::text[];                                                                                     
  prefix text;                                                                                                                
  digits integer;                                                                                                             
  format text;                                                                                                                
  seq integer;                                                                                                                
  candidate text;                                                                                                             
  dept_key text := coalesce(in_sub_department, '');                                                                           
  country_key text := coalesce(in_country, '');                                                                               
  settings_id uuid;                                                                                                           
BEGIN                                                                                                                         
  -- Load settings (singleton) with row-level lock to ensure atomicity                                                        
  SELECT id, number_format, default_prefix, sequence_digits, use_sub_department_prefix, include_country_code,                 
         use_employment_type, custom_prefix_per_pay_group, custom_format, next_sequence, sub_department_rules, country_rules  
  INTO s                                                                                                                      
  FROM public.employee_number_settings                                                                                        
  ORDER BY created_at ASC                                                                                                     
  LIMIT 1                                                                                                                     
  FOR UPDATE;                                                                                                                 
                                                                                                                              
  IF s IS NULL THEN                                                                                                           
    -- create default settings row if missing                                                                                 
    INSERT INTO public.employee_number_settings (default_prefix) VALUES ('EMP') RETURNING id INTO settings_id;                
    SELECT id, number_format, default_prefix, sequence_digits, use_sub_department_prefix, include_country_code,               
           use_employment_type, custom_prefix_per_pay_group, custom_format, next_sequence, sub_department_rules, country_rules
    INTO s                                                                                                                    
    FROM public.employee_number_settings                                                                                      
    WHERE id = settings_id                                                                                                    
    FOR UPDATE;                                                                                                               
  END IF;                                                                                                                     
                                                                                                                              
  digits := s.sequence_digits;                                                                                                
  format := s.number_format;                                                                                                  
                                                                                                                              
  -- Build prefix based on settings unless an override is provided                                                            
  IF in_prefix_override IS NOT NULL AND length(trim(in_prefix_override)) > 0 THEN                                             
    prefix := regexp_replace(upper(trim(in_prefix_override)), '[^A-Z0-9\\-]+', '-', 'g');                                     
  ELSE                                                                                                                        
    prefix_parts := ARRAY[]::text[];                                                                                          
    IF s.include_country_code AND country_key <> '' THEN                                                                      
      prefix_parts := prefix_parts || regexp_replace(upper(country_key), '[^A-Z0-9]+', '-', 'g');                             
    END IF;                                                                                                                   
    IF s.use_employment_type AND coalesce(in_employee_type, '') <> '' THEN                                                    
      prefix_parts := prefix_parts || regexp_replace(upper(in_employee_type), '[^A-Z0-9]+', '-', 'g');                        
    END IF;                                                                                                                   
    IF s.use_sub_department_prefix AND dept_key <> '' THEN                                                                    
      prefix_parts := prefix_parts || regexp_replace(upper(dept_key), '[^A-Z0-9]+', '-', 'g');                                
    ELSE                                                                                                                      
      prefix_parts := prefix_parts || regexp_replace(upper(s.default_prefix), '[^A-Z0-9]+', '-', 'g');                        
    END IF;                                                                                                                   
    prefix := array_to_string(prefix_parts, '-');                                                                             
  END IF;                                                                                                                     
                                                                                                                              
  -- Determine sequence: support per-sub-department start via sub_department_rules                                            
  IF s.sub_department_rules ? dept_key THEN                                                                                   
    seq := (s.sub_department_rules -> dept_key ->> 'next_sequence')::int;                                                     
    IF seq IS NULL OR seq < 1 THEN seq := 1; END IF;                                                                          
    -- increment and save per-sub-department sequence atomically                                                              
    UPDATE public.employee_number_settings                                                                                    
    SET sub_department_rules = jsonb_set(s.sub_department_rules,                                                              
                                      ARRAY[dept_key, 'next_sequence'],                                                       
                                      to_jsonb(seq + 1), true),                                                               
        updated_at = now()                                                                                                    
    WHERE id = s.id;                                                                                                          
  ELSE                                                                                                                        
    seq := s.next_sequence;                                                                                                   
    -- Atomically increment the sequence                                                                                      
    UPDATE public.employee_number_settings                                                                                    
    SET next_sequence = next_sequence + 1,                                                                                    
        updated_at = now()                                                                                                    
    WHERE id = s.id;                                                                                                          
  END IF;                                                                                                                     
                                                                                                                              
  IF format = 'SEQUENCE' THEN                                                                                                 
    candidate := lpad(seq::text, digits, '0');                                                                                
  ELSE                                                                                                                        
    candidate := prefix || '-' || lpad(seq::text, digits, '0');                                                               
  END IF;                                                                                                                     
                                                                                                                              
  -- Ensure uniqueness; loop if collision                                                                                     
  WHILE EXISTS (SELECT 1 FROM public.employees e WHERE e.employee_number = candidate) LOOP                                    
    seq := seq + 1;                                                                                                           
    IF format = 'SEQUENCE' THEN                                                                                               
      candidate := lpad(seq::text, digits, '0');                                                                              
    ELSE                                                                                                                      
      candidate := prefix || '-' || lpad(seq::text, digits, '0');                                                             
    END IF;                                                                                                                   
  END LOOP;                                                                                                                   
                                                                                                                              
  RETURN candidate;                                                                                                           
END;                                                                                                                          
$$                                                                                                                            
Try rerunning the command with --debug to troubleshoot the error.
